name: Coverage
on: [push, pull_request]
jobs:
  Coverage:
    runs-on: [self-hosted, linux, gpu]
    steps:
      - uses: actions/checkout@v3

      # - name: Install CUDA Toolkit
      #   uses: Jimver/cuda-toolkit@v0.2.14
      #   with:
      #     cuda: '11.8.0'
      #     method: network
      #     use-github-cache: false
      #     use-local-cache: false

      - name: Install Dependencies
        run: sudo apt-get update && sudo apt-get install -y cmake gcc g++ git

      - name: Install Catch2
        run:  |
          git clone https://github.com/catchorg/Catch2.git
          cd Catch2
          cmake -Bbuild -H. -DBUILD_TESTING=OFF
          sudo cmake --build build/ --target install --config Debug

      - name: Install lcov
        run: sudo apt-get install lcov

      - name: Configure NiftyReg
        run: |
          mkdir build
          cd build
          cmake -DCMAKE_C_COMPILER=gcc \
                -DCMAKE_CXX_COMPILER=g++ \
                -DCMAKE_BUILD_TYPE=Debug \
                -DBUILD_ALL_DEP=ON \
                -DUSE_CUDA=ON \
                -DUSE_OPENCL=ON \
                -DUSE_SSE=ON \
                -DUSE_OPENMP=ON \
                -DBUILD_TESTING=ON \
                -DWITH_COVERAGE=ON \
                ..

      - name: Build NiftyReg
        run: cmake --build build --config Debug

      - name: Run tests
        working-directory: build
        run: ctest -V

      - name: Coverage
        working-directory: build
        run: make coverage

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v3
        with:
          directory: build
        env:
          CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}